<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sprunki Game — Buttons Play Audio</title>
  <style>
    :root{--bg:#061025;--muted:#9aa8bf;--accent:#fbbf24}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Roboto,Arial;background:linear-gradient(180deg,#031025 0%,#06102a 100%);color:#eaf1ff;padding:18px}
    .wrap{max-width:1000px;margin:0 auto}
    header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
    .title{font-weight:700;font-size:20px}
    .controls{margin-left:auto;display:flex;gap:10px;align-items:center}
    input[type="range"]{width:120px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px}
    .card{display:flex;flex-direction:column;align-items:center;gap:8px;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
    .icon-btn{width:120px;height:120px;border-radius:12px;overflow:hidden;border:0;padding:0;background:transparent;display:flex;align-items:center;justify-content:center}
    .icon-btn img{width:100%;height:100%;object-fit:cover;display:block}
    .label{font-weight:700;font-size:14px;text-align:center;color:#fff}
    .debug{margin-top:12px;color:var(--muted);font-size:13px;white-space:pre-wrap}
    @media (max-width:520px){ .icon-btn{width:96px;height:96px} }
    /* now playing small panel */
    .now-wrap{position:fixed;right:18px;top:18px;width:300px;max-height:60vh;overflow:auto;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);display:none}
    .now-item{display:flex;justify-content:space-between;align-items:center;padding:6px;border-radius:6px;background:rgba(255,255,255,0.01);margin-bottom:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">Sprunki</div>

      <div class="controls">
        <label style="font-size:13px;color:var(--muted)">Volume</label>
        <input id="masterVol" type="range" min="0" max="1" step="0.01" value="1" />
        <button id="stopAll">Stop All</button>
      </div>
    </header>

    <main>
      <section id="grid" class="grid"></section>
      <div id="debug" class="debug">Debug log:</div>
    </main>
  </div>

  <div id="nowWrap" class="now-wrap" aria-live="polite">
    <strong style="display:block;margin-bottom:8px">Now Playing</strong>
    <div id="nowList"></div>
  </div>

<script>
  // ========== CONFIG ==========
  const COUNT = 19;

  // Your uploaded base names:
  // images: button_1, button_2, ..., button_19 (png/jpg/webp) 
  // audios: audio_1, audio_2, ..., audio_19 (mp3/m4a/ogg/wav)
  const IMG_BASENAME = i => `button_${i}`;   // button_1
  const AUD_BASENAME = i => `audio_${i}`;    // audio_1

  // paths to try (first folders, then root)
  const IMG_LOCATORS = [
    name => `buttons/${name}`,  // e.g. buttons/button_1.png
    name => `${name}`           // e.g. button_1.png (repo root)
  ];
  const IMG_EXTS = ['.png','.jpg','.jpeg','.webp'];

  const AUD_LOCATORS = [
    name => `audios/${name}`,   // e.g. audios/audio_1.mp3
    name => `${name}`           // e.g. audio_1.mp3 (repo root)
  ];
  const AUD_EXTS = ['.mp3','.m4a','.ogg','.wav'];
  // ============================

  const grid = document.getElementById('grid');
  const debugEl = document.getElementById('debug');
  const masterVolEl = document.getElementById('masterVol');
  const nowWrap = document.getElementById('nowWrap');
  const nowList = document.getElementById('nowList');

  let masterVolume = Number(masterVolEl.value);
  // Map of playing sounds: key -> {audio, label}
  const playing = new Map();

  function log(...args){
    console.log(...args);
    const text = args.map(a => (typeof a === 'string' ? a : JSON.stringify(a))).join(' ');
    debugEl.textContent += '\n' + text;
    // keep only last ~20 lines
    debugEl.textContent = debugEl.textContent.split('\n').slice(-22).join('\n');
  }

  // Build items
  const items = Array.from({length: COUNT}, (_,k) => {
    const i = k+1;
    // build candidate URLs for icon and audio
    const iconCandidates = [];
    IMG_LOCATORS.forEach(locator => IMG_EXTS.forEach(ext => iconCandidates.push(locator(IMG_BASENAME(i) + ext)));
    const audioCandidates = [];
    AUD_LOCATORS.forEach(locator => AUD_EXTS.forEach(ext => audioCandidates.push(locator(AUD_BASENAME(i) + ext)));
    return {
      index: i,
      label: `Sprunki ${i}`,
      iconCandidates,
      audioCandidates
    };
  });

  // attempt to set img.src to first candidate and onerror rotate through list
  function setImgWithFallback(imgEl, candidates){
    let idx = 0;
    imgEl.src = encodeURI(candidates[idx]);
    imgEl.onerror = () => {
      idx++;
      if(idx < candidates.length){
        // try next candidate
        imgEl.onerror = null; // avoid recursive loop while switching
        imgEl.src = encodeURI(candidates[idx]);
        // reattach error after a tick
        setTimeout(()=> imgEl.onerror = () => setImgWithFallback(imgEl, candidates.slice(idx)), 120);
      } else {
        // none worked -> show text fallback by removing img and letting button show label
        imgEl.remove();
        log('Icon not found. Tried:', candidates.join(', '));
      }
    };
  }

  // create one button card
  function createCard(item){
    const card = document.createElement('div');
    card.className = 'card';

    const btn = document.createElement('button');
    btn.className = 'icon-btn';
    btn.type = 'button';
    btn.title = item.label;

    // create img and attempt load
    const img = document.createElement('img');
    img.alt = item.label;
    setImgWithFallback(img, item.iconCandidates);
    btn.appendChild(img);

    // label shown under button
    const label = document.createElement('div');
    label.className = 'label';
    label.textContent = item.label;

    // click: play audio (overlapping allowed)
    btn.addEventListener('click', () => {
      playAudioFallback(item);
    });

    card.appendChild(btn);
    card.appendChild(label);
    return card;
  }

  // Play audio: try each candidate until one loads (creates a new Audio each call -> overlapping)
  function playAudioFallback(item){
    let attempt = 0;
    function tryNext(){
      if(attempt >= item.audioCandidates.length){
        log('Audio not found for', item.label, 'Tried:', item.audioCandidates.join(', '));
        return;
      }
      const url = item.audioCandidates[attempt];
      log('Trying audio:', url);
      const a = new Audio(encodeURI(url));
      a.preload = 'auto';
      a.volume = masterVolume;
      const key = `${item.index}-${Date.now()}-${Math.random().toString(36).slice(2,6)}`;
      playing.set(key, {audio: a, label: item.label});
      renderNowPlaying();

      let errored = false;
      a.addEventListener('error', () => {
        errored = true;
        playing.delete(key);
        renderNowPlaying();
        attempt++;
        tryNext();
      });
      a.addEventListener('canplaythrough', () => {
        if(!errored) a.play().catch(()=>{});
      });
      a.addEventListener('ended', () => {
        playing.delete(key);
        renderNowPlaying();
      });
      // attempt to play (click is a user gesture so should be allowed)
      a.play().catch(()=>{ /* ignore rejection */ });
    }
    tryNext();
  }

  // render small now-playing panel
  function renderNowPlaying(){
    if(playing.size === 0){
      nowWrap.style.display = 'none';
      nowList.innerHTML = '';
      return;
    }
    nowWrap.style.display = 'block';
    nowList.innerHTML = '';
    Array.from(playing.entries()).forEach(([key, rec]) => {
      const row = document.createElement('div');
      row.className = 'now-item';
      const left = document.createElement('div');
      left.innerHTML = `<div style="font-weight:700">${rec.label}</div><div style="font-size:12px;color:var(--muted)">${rec.audio.src.split('/').pop()}</div>`;
      const right = document.createElement('div');
      const stopBtn = document.createElement('button');
      stopBtn.textContent = '⏹';
      stopBtn.title = 'Stop';
      stopBtn.addEventListener('click', ()=> {
        try{ rec.audio.pause(); rec.audio.currentTime = 0; } catch(e){}
        playing.delete(key);
        renderNowPlaying();
      });
      right.appendChild(stopBtn);
      row.appendChild(left);
      row.appendChild(right);
      nowList.appendChild(row);
    });
  }

  // Stop All button behavior: pause & reset all audios, clear Map, update UI
  document.getElementById('stopAll').addEventListener('click', () => {
    playing.forEach((rec, key) => {
      try{ rec.audio.pause(); rec.audio.currentTime = 0; } catch(e) {}
    });
    playing.clear();
    renderNowPlaying();
    log('All sounds stopped.');
  });

  // master volume control
  masterVolEl.addEventListener('input', (e) => {
    masterVolume = Number(e.target.value);
    playing.forEach(rec => { try{ rec.audio.volume = masterVolume; }catch(e){} });
  });

  // populate 19 buttons
  items.forEach(it => grid.appendChild(createCard(it)));

  log('Ready. Buttons displayed. Click a button to play its audio (overlap allowed). If an icon does not show, check file placement and names.');

</script>
</body>
</html>
