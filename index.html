<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sprunki Game</title>
  <style>
    :root{--bg:#061025;--muted:#9aa8bf;--accent:#fbbf24}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Roboto,Arial;background:linear-gradient(180deg,#031025 0%,#06102a 100%);color:#eaf1ff;padding:18px}
    .wrap{max-width:1000px;margin:0 auto}
    header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
    .title{font-weight:700;font-size:20px}
    .controls{margin-left:auto;display:flex;gap:10px;align-items:center}
    input[type="range"]{width:120px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px}
    .card{display:flex;flex-direction:column;align-items:center;gap:8px;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
    .icon-btn{width:120px;height:120px;border-radius:12px;overflow:hidden;border:0;padding:0;background:transparent;display:flex;align-items:center;justify-content:center}
    .icon-btn img{width:100%;height:100%;object-fit:cover;display:block}
    .label{font-weight:700;font-size:14px;text-align:center;color:#fff}
    .debug{margin-top:12px;color:var(--muted);font-size:13px;white-space:pre-wrap}
    @media (max-width:520px){ .icon-btn{width:96px;height:96px} }
    .now-wrap{position:fixed;right:18px;top:18px;width:300px;max-height:60vh;overflow:auto;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);display:none}
    .now-item{display:flex;justify-content:space-between;align-items:center;padding:6px;border-radius:6px;background:rgba(255,255,255,0.01);margin-bottom:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">Sprunki</div>

      <div class="controls">
        <label style="font-size:13px;color:var(--muted)">Volume</label>
        <input id="masterVol" type="range" min="0" max="1" step="0.01" value="1" />
        <button id="stopAll">Stop All</button>
      </div>
    </header>

    <main>
      <section id="grid" class="grid" aria-label="Sprunki buttons"></section>
      <div id="debug" class="debug">Debug log:</div>
    </main>
  </div>

  <div id="nowWrap" class="now-wrap" aria-live="polite">
    <strong style="display:block;margin-bottom:8px">Now Playing</strong>
    <div id="nowList"></div>
  </div>

<script>
  // CONFIG (matches your uploaded files in repo root)
  const COUNT = 19;
  const BTN_BASE = i => `button_${i}`;  // button_1, button_2, ...
  const AUD_BASE = i => `audio_${i}`;    // audio_1, audio_2, ...

  // since files are in the same folder as index.html (root), we only try root
  const IMG_EXTS = ['.png', '.jpg', '.jpeg', '.webp'];
  const AUD_EXTS = ['.mp3', '.m4a', '.ogg', '.wav'];

  const grid = document.getElementById('grid');
  const debugEl = document.getElementById('debug');
  const masterVolEl = document.getElementById('masterVol');
  const nowWrap = document.getElementById('nowWrap');
  const nowList = document.getElementById('nowList');

  let masterVolume = Number(masterVolEl.value);
  const playing = new Map(); // key -> {audio, label}

  function log(...args){
    console.log(...args);
    const s = args.map(a => (typeof a === 'string' ? a : JSON.stringify(a))).join(' ');
    debugEl.textContent += '\n' + s;
    debugEl.textContent = debugEl.textContent.split('\n').slice(-22).join('\n');
  }

  // build items for 1..COUNT
  const items = Array.from({length: COUNT}, (_,k) => {
    const i = k+1;
    const iconCandidates = IMG_EXTS.map(ext => `${BTN_BASE(i)}${ext}`);
    const audioCandidates = AUD_EXTS.map(ext => `${AUD_BASE(i)}${ext}`);
    return {
      index: i,
      label: `Sprunki ${i}`,
      iconCandidates,
      audioCandidates
    };
  });

  // Try to load image candidates sequentially for a given <img>
  function setImgWithFallback(imgEl, candidates){
    let idx = 0;
    function tryIdx(i){
      if(i >= candidates.length){
        // no image found -> remove img so button displays text fallback
        imgEl.remove();
        log('No button image found for', imgEl.alt, 'tried:', candidates.join(', '));
        return;
      }
      const candidate = candidates[i];
      imgEl.onerror = () => { tryIdx(i+1); };
      imgEl.src = encodeURI(candidate);
    }
    tryIdx(idx);
  }

  // Create a button card for each item
  function createCard(item){
    const card = document.createElement('div');
    card.className = 'card';

    const btn = document.createElement('button');
    btn.className = 'icon-btn';
    btn.type = 'button';
    btn.title = item.label;

    const img = document.createElement('img');
    img.alt = item.label;
    // Start trying image files in repo root (button_1.png, .jpg, ...)
    setImgWithFallback(img, item.iconCandidates);
    btn.appendChild(img);

    // Label under the button (Sprunki X)
    const label = document.createElement('div');
    label.className = 'label';
    label.textContent = item.label;

    // click -> play audio (overlap allowed)
    btn.addEventListener('click', () => {
      playAudioFallback(item);
    });

    card.appendChild(btn);
    card.appendChild(label);
    return card;
  }

  // Play audio, try extensions if some missing
  function playAudioFallback(item){
    let attempt = 0;
    function tryOne(){
      if(attempt >= item.audioCandidates.length){
        log('Audio not found for', item.label, 'Tried: ' + item.audioCandidates.join(', '));
        return;
      }
      const url = item.audioCandidates[attempt];
      log('Trying audio:', url);
      const a = new Audio(encodeURI(url));
      a.preload = 'auto';
      a.volume = masterVolume;

      const key = `${item.index}-${Date.now()}-${Math.random().toString(36).slice(2,6)}`;
      playing.set(key, {audio: a, label: item.label});
      renderNowPlaying();

      let errored = false;
      a.addEventListener('error', () => {
        errored = true;
        playing.delete(key);
        renderNowPlaying();
        attempt++;
        tryOne();
      });
      a.addEventListener('canplaythrough', () => {
        if(!errored) a.play().catch(()=>{});
      });
      a.addEventListener('ended', () => {
        playing.delete(key);
        renderNowPlaying();
      });
      a.play().catch(()=>{ /* ignore */ });
    }
    tryOne();
  }

  // Render "Now Playing" panel
  function renderNowPlaying(){
    if(playing.size === 0){
      nowWrap.style.display = 'none';
      nowList.innerHTML = '';
      return;
    }
    nowWrap.style.display = 'block';
    nowList.innerHTML = '';
    Array.from(playing.entries()).forEach(([key, rec]) => {
      const row = document.createElement('div');
      row.className = 'now-item';
      const left = document.createElement('div');
      left.innerHTML = `<div style="font-weight:700">${rec.label}</div><div style="font-size:12px;color:var(--muted)">${rec.audio.src.split('/').pop()}</div>`;
      const right = document.createElement('div');
      const stopBtn = document.createElement('button');
      stopBtn.textContent = '⏹';
      stopBtn.title = 'Stop';
      stopBtn.addEventListener('click', () => {
        try{ rec.audio.pause(); rec.audio.currentTime = 0; }catch(e){}
        playing.delete(key);
        renderNowPlaying();
      });
      right.appendChild(stopBtn);
      row.appendChild(left);
      row.appendChild(right);
      nowList.appendChild(row);
    });
  }

  // Stop All: pause + reset all audios, clear Map, update UI
  document.getElementById('stopAll').addEventListener('click', () => {
    playing.forEach((rec, key) => {
      try{ rec.audio.pause(); rec.audio.currentTime = 0; }catch(e){}
    });
    playing.clear();
    renderNowPlaying();
    log('All sounds stopped.');
  });

  // master volume
  masterVolEl.addEventListener('input', (e) => {
    masterVolume = Number(e.target.value);
    playing.forEach(rec => { try{ rec.audio.volume = masterVolume; }catch(e){} });
  });

  // Populate UI with 19 Sprunki buttons
  items.forEach(it => grid.appendChild(createCard(it)));

  log('Ready — buttons use button_1..button_19 (root). Labels are Sprunki 1..19. Click to play audio_1..audio_19 (root).');

</script>
</body>
</html>
