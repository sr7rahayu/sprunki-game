<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sprunki Game</title>
  <style>
    :root{--muted:#9aa8bf}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Roboto,Arial;background:#031025;color:#eaf1ff;padding:18px}
    .wrap{max-width:980px;margin:0 auto}
    header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
    .title{font-weight:700;font-size:20px}
    .controls{margin-left:auto;display:flex;gap:10px;align-items:center}
    input[type="range"]{width:120px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px}
    .card{display:flex;flex-direction:column;align-items:center;gap:8px;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
    .icon-btn{width:120px;height:120px;border-radius:12px;overflow:hidden;border:0;padding:0;background:transparent;display:flex;align-items:center;justify-content:center}
    .icon-btn img{width:100%;height:100%;object-fit:cover;display:block}
    .label{font-weight:700;font-size:14px;text-align:center;color:#fff}
    .debug{margin-top:12px;color:var(--muted);font-size:13px;white-space:pre-wrap}
    .now-wrap{position:fixed;right:18px;top:18px;width:300px;max-height:60vh;overflow:auto;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);display:none}
    .now-item{display:flex;justify-content:space-between;align-items:center;padding:6px;border-radius:6px;background:rgba(255,255,255,0.01);margin-bottom:8px}
    @media (max-width:520px){ .icon-btn{width:96px;height:96px} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">Sprunki</div>
      <div class="controls">
        <label style="font-size:13px;color:var(--muted)">Volume</label>
        <input id="masterVol" type="range" min="0" max="1" step="0.01" value="1"/>
        <button id="stopAll">Stop All</button>
      </div>
    </header>

    <main>
      <section id="grid" class="grid" aria-label="Sprunki buttons"></section>
      <div id="debug" class="debug">Debug log:</div>
    </main>
  </div>

  <div id="nowWrap" class="now-wrap" aria-live="polite">
    <strong style="display:block;margin-bottom:8px">Now Playing</strong>
    <div id="nowList"></div>
  </div>

<script>
(async function(){
  // ---------------- CONFIG ----------------
  const COUNT = 19;
  const BTN_BASE = i => `button_${i}`;   // button_1, button_2, ... (repo root)
  const AUD_BASE = i => `audio_${i}`;    // audio_1, audio_2, ...
  const IMG_EXTS = ['.png','.jpg','.jpeg','.webp'];
  const AUD_EXTS = ['.mp3','.m4a','.ogg','.wav'];
  // ----------------------------------------

  const grid = document.getElementById('grid');
  const debugEl = document.getElementById('debug');
  const masterVolEl = document.getElementById('masterVol');
  const nowWrap = document.getElementById('nowWrap');
  const nowList = document.getElementById('nowList');

  let masterVolume = Number(masterVolEl.value);
  const playing = new Map(); // key -> {audio, label}

  function log(...args){
    console.log(...args);
    const s = args.map(a => (typeof a === 'string' ? a : JSON.stringify(a))).join(' ');
    debugEl.textContent += '\n' + s;
    debugEl.textContent = debugEl.textContent.split('\n').slice(-22).join('\n');
  }

  // find first reachable URL from candidate list using HEAD requests
  async function findAvailableUrl(candidates){
    for(const c of candidates){
      try{
        // use HEAD to check quickly
        const res = await fetch(encodeURI(c), { method:'HEAD' });
        if(res.ok) return c;
        // some servers disallow HEAD; try GET fallback for small file check
        if(res.status === 405 || res.status === 501){
          const res2 = await fetch(encodeURI(c), { method:'GET', headers: { Range: 'bytes=0-0' } });
          if(res2.ok) return c;
        }
      }catch(e){
        // network or CORS error — we still continue trying other candidates
      }
    }
    return null;
  }

  // Build items array and prepare UI placeholders
  const items = Array.from({length: COUNT}, (_,k) => {
    const i = k+1;
    return {
      index: i,
      label: `Sprunki ${i}`,
      iconCandidates: IMG_EXTS.map(ext => `${BTN_BASE(i)}${ext}`),
      audioCandidates: AUD_EXTS.map(ext => `${AUD_BASE(i)}${ext}`)
    };
  });

  // create placeholder card and return references to DOM nodes for later updates
  function createCardSkeleton(item){
    const card = document.createElement('div'); card.className='card';
    const btn = document.createElement('button'); btn.className='icon-btn'; btn.type='button'; btn.title = item.label;
    // in the beginning put a blank placeholder element
    const placeholder = document.createElement('div');
    placeholder.style.width = '100%';
    placeholder.style.height = '100%';
    placeholder.style.display = 'flex';
    placeholder.style.alignItems = 'center';
    placeholder.style.justifyContent = 'center';
    placeholder.style.background = 'linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))';
    placeholder.style.color = '#fff';
    placeholder.textContent = 'Loading...';
    btn.appendChild(placeholder);

    const label = document.createElement('div'); label.className='label'; label.textContent = item.label;

    card.appendChild(btn); card.appendChild(label);
    grid.appendChild(card);

    return { card, btn, placeholder, label };
  }

  // create all skeletons and keep references
  const domRefs = items.map(item => ({ item, refs: createCardSkeleton(item) }));

  // For each item: find available icon file, replace placeholder with <img> or fallback text,
  // set up click handler to play audio (audio will be resolved on click)
  await Promise.all(domRefs.map(async ({ item, refs })=>{
    // 1) find available icon (png/jpg/webp) in repo root
    const iconUrl = await findAvailableUrl(item.iconCandidates);
    // replace placeholder with image if available
    refs.btn.innerHTML = ''; // clear placeholder
    if(iconUrl){
      const img = document.createElement('img');
      img.alt = item.label;
      img.src = encodeURI(iconUrl);
      img.onload = ()=> {}; // image loads normally
      img.onerror = ()=> { // if image somehow fails, fallback to label text
        img.remove();
        refs.btn.textContent = item.label;
        refs.btn.style.fontWeight = '700';
        refs.btn.style.background = 'linear-gradient(90deg,#fbbf24,#f97316)';
        refs.btn.style.color = '#071026';
      };
      refs.btn.appendChild(img);
      log('Loaded icon for', item.label, '->', iconUrl);
    } else {
      // no icon found: show text button
      refs.btn.textContent = item.label;
      refs.btn.style.fontWeight = '700';
      refs.btn.style.background = 'linear-gradient(90deg,#fbbf24,#f97316)';
      refs.btn.style.color = '#071026';
      log('No icon found for', item.label, '; showing text button');
    }

    // 2) attach click handler: on click, play audio (try candidate extensions)
    refs.btn.addEventListener('click', ()=> {
      playAudioWithFallback(item);
    });
  }));

  // Audio play with fallback: try each extension until one loads / plays.
  function playAudioWithFallback(item){
    let attempt = 0;
    function tryOne(){
      if(attempt >= item.audioCandidates.length){
        log('Audio not found for', item.label, 'Tried:', item.audioCandidates.join(', '));
        // small non-blocking message (optional)
        // alert(`Audio not found for ${item.label}`);
        return;
      }
      const candidate = item.audioCandidates[attempt];
      log('Trying audio candidate:', candidate);
      const a = new Audio(encodeURI(candidate));
      a.preload = 'auto';
      a.volume = masterVolume;
      const key = `${item.index}-${Date.now()}-${Math.random().toString(36).slice(2,6)}`;
      playing.set(key, { audio: a, label: item.label });
      renderNowPlaying();

      let errored = false;
      a.addEventListener('error', ()=> {
        errored = true;
        playing.delete(key);
        renderNowPlaying();
        attempt++;
        tryOne();
      });
      a.addEventListener('canplaythrough', ()=> {
        if(!errored) a.play().catch(()=>{});
      });
      a.addEventListener('ended', ()=> {
        playing.delete(key);
        renderNowPlaying();
      });
      // attempt play (click is a user gesture so this usually works)
      a.play().catch(()=>{ /* ignore play() rejection */ });
    }
    tryOne();
  }

  // render now-playing
  function renderNowPlaying(){
    if(playing.size === 0){
      nowWrap.style.display = 'none';
      nowList.innerHTML = '';
      return;
    }
    nowWrap.style.display = 'block';
    nowList.innerHTML = '';
    Array.from(playing.entries()).forEach(([key, rec])=>{
      const row = document.createElement('div'); row.className='now-item';
      const left = document.createElement('div');
      left.innerHTML = `<div style="font-weight:700">${rec.label}</div><div style="font-size:12px;color:var(--muted)">${rec.audio.src.split('/').pop()}</div>`;
      const right = document.createElement('div');
      const stopBtn = document.createElement('button');
      stopBtn.textContent = '⏹';
      stopBtn.title = 'Stop';
      stopBtn.addEventListener('click', ()=> {
        try{ rec.audio.pause(); rec.audio.currentTime = 0; }catch(e){}
        playing.delete(key);
        renderNowPlaying();
      });
      right.appendChild(stopBtn);
      row.appendChild(left); row.appendChild(right);
      nowList.appendChild(row);
    });
  }

  // Stop All: stop, reset and clear the map
  document.getElementById('stopAll').addEventListener('click', ()=>{
    playing.forEach((rec, key) => {
      try{ rec.audio.pause(); rec.audio.currentTime = 0; }catch(e){}
    });
    playing.clear();
    renderNowPlaying();
    log('All sounds stopped.');
  });

  // master volume
  masterVolEl.addEventListener('input', (e)=> {
    masterVolume = Number(e.target.value);
    playing.forEach(rec => { try{ rec.audio.volume = masterVolume; }catch(e){} });
  });

  // initial log
  log('Initialization finished. If an image does not appear, check the exact filename (case-sensitive) and extension.');
  log('Example tested paths for item 1:', items[0].iconCandidates.join(', '));
  log('Example audio paths for item 1:', items[0].audioCandidates.join(', '));
})();
</script>
</body>
</html>
