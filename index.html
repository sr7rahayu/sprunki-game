<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sprunki Game</title>
<style>
  :root{--muted:#9aa8bf;--accent:#fbbf24}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Roboto,Arial;background:#031025;color:#eaf1ff;padding:18px}
  .wrap{max-width:980px;margin:0 auto}
  header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .title{font-weight:700;font-size:20px}
  .controls{margin-left:auto;display:flex;gap:10px;align-items:center}
  input[type="range"]{width:120px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:12px}
  .card{display:flex;flex-direction:column;align-items:center;gap:6px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
  .icon-btn{width:88px;height:88px;border-radius:10px;overflow:hidden;border:0;padding:0;background:transparent;display:flex;align-items:center;justify-content:center}
  .icon-btn img{width:100%;height:100%;object-fit:cover;display:block}
  .label{font-weight:700;font-size:13px;text-align:center;color:#fff}
  .debug{margin-top:12px;color:var(--muted);font-size:13px;white-space:pre-wrap}
  .now-wrap{position:fixed;right:12px;top:12px;width:260px;max-height:60vh;overflow:auto;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);display:none}
  .now-item{display:flex;justify-content:space-between;align-items:center;padding:6px;border-radius:6px;background:rgba(255,255,255,0.01);margin-bottom:6px}
  @media (max-width:520px){ .icon-btn{width:72px;height:72px} .label{font-size:12px} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">Sprunki</div>
      <div class="controls">
        <label style="font-size:13px;color:var(--muted)">Volume</label>
        <input id="masterVol" type="range" min="0" max="1" step="0.01" value="1">
        <button id="stopAll">Stop All</button>
      </div>
    </header>

    <main>
      <section id="grid" class="grid" aria-label="Sprunki buttons"></section>
      <div id="debug" class="debug" aria-hidden="true">Debug (last lines):</div>
    </main>
  </div>

  <div id="nowWrap" class="now-wrap" aria-live="polite">
    <strong style="display:block;margin-bottom:8px">Now Playing</strong>
    <div id="nowList"></div>
  </div>

<script>
(function(){
  // CONFIG — uses repo root files: button_1.png ... button_19.png and audio_1(.mp3/.m4a/.ogg/.wav)
  const COUNT = 19;
  const BTN_NAME = i => `button_${i}`; // expects button_1.png etc
  const AUD_NAME = i => `audio_${i}`;   // expects audio_1.mp3 etc
  const IMG_EXT = '.png'; // you said images are PNG — keep primary .png
  const AUDIO_EXTS = ['.mp3', '.m4a', '.ogg', '.wav']; // fallback order for audio

  const grid = document.getElementById('grid');
  const debugEl = document.getElementById('debug');
  const masterVolEl = document.getElementById('masterVol');
  const nowWrap = document.getElementById('nowWrap');
  const nowList = document.getElementById('nowList');

  let masterVolume = Number(masterVolEl.value);
  // map of active audio objects (unique key -> {audio,label})
  const playing = new Map();

  function log(...args){
    console.log(...args);
    const line = args.map(a => typeof a === 'string' ? a : JSON.stringify(a)).join(' ');
    debugEl.textContent = (debugEl.textContent + '\n' + line).split('\n').slice(-18).join('\n');
  }

  // Create UI buttons expecting button_X.png in repo root
  for(let i=1;i<=COUNT;i++){
    const itemLabel = `Sprunki ${i}`;
    const card = document.createElement('div'); card.className='card';

    const btn = document.createElement('button'); btn.className='icon-btn'; btn.type='button'; btn.title = itemLabel;
    const img = document.createElement('img');
    img.alt = itemLabel;
    img.src = encodeURI(`${BTN_NAME(i)}${IMG_EXT}`); // button_1.png

    // if image load fails, fallback to text-styled button
    img.onerror = () => {
      img.remove();
      btn.textContent = itemLabel;
      btn.style.fontWeight = '700';
      btn.style.background = 'linear-gradient(90deg,#fbbf24,#f97316)';
      btn.style.color = '#071026';
      btn.style.borderRadius = '10px';
      btn.style.padding = '8px';
    };

    btn.appendChild(img);
    const label = document.createElement('div'); label.className='label'; label.textContent = itemLabel;

    btn.addEventListener('click', ()=> {
      playAudioForIndex(i, itemLabel);
    });

    card.appendChild(btn);
    card.appendChild(label);
    grid.appendChild(card);
  }

  // Play audio for index i — tries extensions in AUDIO_EXTS
  function playAudioForIndex(i, label){
    let attempt = 0;
    function tryOne(){
      if(attempt >= AUDIO_EXTS.length){
        log('Audio not found for', label, 'tried:', AUDIO_EXTS.map(e=>`${AUD_NAME(i)}${e}`).join(', '));
        return;
      }
      const url = `${AUD_NAME(i)}${AUDIO_EXTS[attempt]}`; // audio_1.mp3, fallback...
      log('Trying audio:', url);
      const a = new Audio(encodeURI(url));
      a.preload = 'auto';
      a.volume = masterVolume;
      const key = `${i}-${Date.now()}-${Math.random().toString(36).slice(2,6)}`;
      playing.set(key, { audio: a, label });

      // add to now-playing UI
      renderNowPlaying();

      let errored = false;
      a.addEventListener('error', ()=> {
        errored = true;
        playing.delete(key);
        renderNowPlaying();
        attempt++;
        tryOne();
      });
      a.addEventListener('canplaythrough', ()=> {
        if(!errored){
          a.play().catch(()=>{});
        }
      });
      a.addEventListener('ended', ()=> {
        playing.delete(key);
        renderNowPlaying();
      });
      // trigger play attempt
      a.play().catch(()=>{ /* ignore */ });
    }
    tryOne();
  }

  // Render now-playing panel
  function renderNowPlaying(){
    if(playing.size === 0){
      nowWrap.style.display = 'none';
      nowList.innerHTML = '';
      return;
    }
    nowWrap.style.display = 'block';
    nowList.innerHTML = '';
    Array.from(playing.entries()).forEach(([key, rec]) => {
      const row = document.createElement('div'); row.className = 'now-item';
      const left = document.createElement('div');
      left.innerHTML = `<div style="font-weight:700">${rec.label}</div><div style="font-size:12px;color:var(--muted)">${rec.audio.src.split('/').pop()}</div>`;
      const right = document.createElement('div');
      const stopBtn = document.createElement('button'); stopBtn.textContent = '⏹'; stopBtn.title = 'Stop';
      stopBtn.addEventListener('click', ()=> {
        try{ rec.audio.pause(); rec.audio.currentTime = 0; }catch(e){}
        playing.delete(key);
        renderNowPlaying();
      });
      right.appendChild(stopBtn);
      row.appendChild(left); row.appendChild(right);
      nowList.appendChild(row);
    });
  }

  // Stop All: pause & reset all audio and clear the map
  document.getElementById('stopAll').addEventListener('click', ()=> {
    playing.forEach((rec, key) => {
      try{ rec.audio.pause(); rec.audio.currentTime = 0; }catch(e){}
    });
    playing.clear();
    renderNowPlaying();
    log('All sounds stopped.');
  });

  // Master volume
  masterVolEl.addEventListener('input', (e)=>{
    masterVolume = Number(e.target.value);
    playing.forEach(rec => { try{ rec.audio.volume = masterVolume; }catch(e){} });
  });

  // initial debug note
  log('Sprunki game loaded. Expecting files in repo root: button_1.png ... button_19.png and audio_1(.mp3/.m4a/.ogg/.wav).');

})();
</script>
</body>
</html>
